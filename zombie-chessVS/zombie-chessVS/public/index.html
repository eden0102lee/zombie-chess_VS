<!doctype html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>æ®­å±æ£‹ Online - é€£ç·šå°æˆ°ç‰ˆ</title>
        <style>
            :root {
                --bg0: #0f172a;
                --bg1: #111c33;
                --p1: #ef4444;
                --p2: #3b82f6;
                --gold: #fbbf24;
                --move: rgba(34, 197, 94, 0.55);
                --attack: rgba(239, 68, 68, 0.55);
                --sac: rgba(251, 191, 36, 0.55);
                --stack-jump: rgba(168, 85, 247, 0.65);
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                font-family: "Microsoft JhengHei", system-ui, sans-serif;
                color: #e5e7eb;
                background: radial-gradient(circle at 50% 0%, #1e293b, #0f172a);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                user-select: none;
            }

            /* é€£ç·šå¤§å»³é®ç½© */
            #lobby-overlay {
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.95);
                z-index: 9999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .lobby-box {
                background: #1e293b;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            }
            .lobby-fields {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 16px;
            }
            .lobby-row {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                color: #e2e8f0;
            }
            .lobby-row label {
                width: 52px;
                text-align: right;
                font-size: 14px;
                color: #cbd5f5;
            }
            .lobby-row input {
                margin-bottom: 0;
                width: 220px;
            }
            .lobby-input {
                padding: 15px;
                font-size: 18px;
                border-radius: 10px;
                border: none;
                margin-bottom: 20px;
                width: 250px;
                text-align: center;
            }
            .lobby-btn {
                padding: 15px 30px;
                font-size: 18px;
                border-radius: 10px;
                border: none;
                background: var(--gold);
                color: #000;
                font-weight: bold;
                cursor: pointer;
                transition: 0.2s;
            }
            .lobby-btn:hover {
                transform: scale(1.05);
            }
            .room-list {
                margin-top: 25px;
                text-align: left;
                max-height: 260px;
                overflow-y: auto;
                padding: 0 5px;
            }
            .room-list h2 {
                margin: 0 0 10px;
                font-size: 16px;
                color: #e2e8f0;
            }
            .room-section-title--spaced {
                margin-top: 18px;
            }
            .room-list ul {
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .room-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: rgba(15, 23, 42, 0.6);
                border: 1px solid rgba(148, 163, 184, 0.3);
                border-radius: 12px;
                padding: 10px 12px;
            }
            .room-item--inactive {
                background: rgba(148, 163, 184, 0.2);
                border-color: rgba(148, 163, 184, 0.5);
            }
            .room-item--inactive .room-meta span {
                color: #e2e8f0;
            }
            .room-item--inactive .room-join {
                background: #94a3b8;
                color: #1f2937;
            }
            .room-meta {
                display: flex;
                flex-direction: column;
                gap: 4px;
                font-size: 14px;
            }
            .room-meta span {
                color: #cbd5f5;
            }
            .room-meta small {
                color: #94a3b8;
            }
            .room-join {
                padding: 8px 14px;
                font-size: 14px;
                border-radius: 8px;
                border: none;
                background: #38bdf8;
                color: #0f172a;
                font-weight: 700;
                cursor: pointer;
            }
            .room-join:disabled {
                opacity: 0.4;
                cursor: not-allowed;
            }
            .room-empty {
                font-size: 14px;
                color: #94a3b8;
                text-align: center;
                padding: 12px 0;
            }
            .room-refresh {
                margin-top: 8px;
                font-size: 12px;
                padding: 6px 12px;
                border-radius: 999px;
                border: 1px solid rgba(148, 163, 184, 0.5);
                background: transparent;
                color: #e2e8f0;
                cursor: pointer;
            }

            /* éŠæˆ²ä»‹é¢ */
            #game-container {
                display: none;
                width: 100%;
                max-width: 1000px;
                gap: 20px;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
            }
            .wrap {
                display: grid;
                grid-template-columns: 1fr 340px;
                gap: 20px;
                width: 100%;
            }
            @media (max-width: 900px) {
                .wrap {
                    grid-template-columns: 1fr;
                }
            }

            .card {
                background: rgba(255, 255, 255, 0.06);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 16px;
                padding: 15px;
            }
            .side-column {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .rules-card {
                margin-top: 20px;
            }
            .rules-card summary {
                cursor: pointer;
                font-weight: 700;
                font-size: 16px;
                color: #e2e8f0;
                outline: none;
                list-style: none;
            }
            .rules-card summary::-webkit-details-marker {
                display: none;
            }
            .rules-card summary::after {
                content: "â–¼";
                margin-left: 8px;
                font-size: 12px;
                color: #94a3b8;
            }
            .rules-card[open] summary::after {
                content: "â–²";
            }
            .rules-card[open] summary {
                margin-bottom: 12px;
            }
            .rules-content {
                font-size: 13px;
                line-height: 1.65;
                color: #cbd5f5;
                max-height: 520px;
                overflow-y: auto;
                padding-right: 6px;
            }
            .rules-content h4 {
                margin: 12px 0 6px;
                font-size: 14px;
                color: #e2e8f0;
            }
            .rules-content ul,
            .rules-content ol {
                padding-left: 18px;
                margin: 6px 0 10px;
            }
            .rules-content li {
                margin-bottom: 6px;
            }
            .board-frame {
                display: flex;
                justify-content: center;
                padding: 10px;
            }
            #game-board {
                display: grid;
                grid-template-columns: repeat(7, 68px);
                grid-template-rows: repeat(7, 68px);
                gap: 6px;
                background: #0b1222;
                padding: 12px;
                border-radius: 14px;
            }

            .cell {
                border-radius: 12px;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            }
            .cell.underworld {
                background: #f1f5f9;
            }
            .cell.afterlife {
                background: #1f2b44;
                border: 1px dashed rgba(255, 255, 255, 0.15);
            }
            .cell.afterlife::before {
                content: "é™½";
                position: absolute;
                top: 4px;
                left: 6px;
                font-size: 10px;
                opacity: 0.3;
            }

            .cell.selected {
                outline: 4px solid var(--gold);
                z-index: 10;
            }

            /* è¦–è¦ºæŒ‡ç¤ºå™¨ */
            .indicator {
                position: absolute;
                pointer-events: none;
                z-index: 40;
            }
            .indicator-move {
                width: 18px;
                height: 18px;
                background: rgba(34, 197, 94, 0.9);
                border-radius: 50%;
                box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
            }
            .indicator-attack {
                width: 100%;
                height: 100%;
                border: 4px solid rgba(239, 68, 68, 0.85);
                border-radius: 12px;
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
                animation: pulse-red 1.5s infinite;
            }
            .indicator-sacrifice {
                width: 100%;
                height: 100%;
                border: 4px solid var(--sac);
                border-radius: 12px;
                background: rgba(251, 191, 36, 0.15);
            }
            .valid-revive-hint {
                box-shadow: inset 0 0 0 3px rgba(34, 197, 94, 0.6);
                background: rgba(34, 197, 94, 0.1);
            }
            .valid-jump-stack {
                background: var(--stack-jump);
            }
            @keyframes pulse-red {
                0% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                }
            }

            .piece-container {
                width: 100%;
                height: 100%;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                pointer-events: none;
            }
            .piece {
                border-radius: 50%;
                border: 2px solid rgba(0, 0, 0, 0.3);
                position: absolute;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 900;
                color: #fff;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            }
            .piece.p1 {
                background: radial-gradient(
                    circle at 30% 30%,
                    #fca5a5,
                    var(--p1)
                );
                text-shadow: 0 1px 2px #991b1b;
            }
            .piece.p2 {
                background: radial-gradient(
                    circle at 30% 30%,
                    #93c5fd,
                    var(--p2)
                );
                text-shadow: 0 1px 2px #1e40af;
            }
            .size-S {
                width: 34px;
                height: 34px;
                z-index: 30;
                font-size: 12px;
            }
            .size-M {
                width: 46px;
                height: 46px;
                z-index: 20;
                font-size: 14px;
            }
            .size-L {
                width: 58px;
                height: 58px;
                z-index: 10;
                font-size: 16px;
            }

            .stack-dot {
                width: 22px;
                height: 22px;
                background: var(--gold);
                border: 2px solid #fff;
                border-radius: 50%;
                position: absolute;
                z-index: 100;
                animation: pulse 1s infinite;
                box-shadow: 0 0 10px var(--gold);
                cursor: pointer;
                pointer-events: auto;
            }
            @keyframes pulse {
                0% {
                    transform: scale(0.9);
                }
                50% {
                    transform: scale(1.2);
                }
                100% {
                    transform: scale(0.9);
                }
            }

            .btn {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #fff;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                width: 100%;
                margin-top: 5px;
            }
            .btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            .btn:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }
            .btn.active {
                background: var(--gold);
                color: #000;
            }
            .btn.combo {
                background: #22c55e;
                border-color: #22c55e;
                display: none;
            }

            .status-bar {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-weight: bold;
                font-size: 1.1em;
            }
            .supply-row {
                display: flex;
                gap: 5px;
                margin-bottom: 8px;
            }
            .supply-btn {
                flex: 1;
                font-size: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .log-area {
                height: 150px;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.3);
                padding: 10px;
                border-radius: 8px;
                font-size: 13px;
                color: #ccc;
                margin-top: 15px;
            }
            .log-line {
                margin-bottom: 4px;
                border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
                padding-bottom: 2px;
            }

            .my-turn {
                box-shadow: 0 0 15px var(--gold);
                border-color: var(--gold);
            }
            .winner-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            }
            .winner-text {
                font-size: 3em;
                color: var(--gold);
                margin-bottom: 20px;
                text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
            }
            #git-version {
                position: fixed;
                top: 12px;
                left: 12px;
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 12px;
                letter-spacing: 0.5px;
                background: rgba(15, 23, 42, 0.7);
                border: 1px solid rgba(148, 163, 184, 0.4);
                color: #e2e8f0;
                z-index: 10001;
                backdrop-filter: blur(6px);
            }
            .nickname-field {
                position: relative;
                display: inline-flex;
                align-items: center;
            }
            .nickname-field input {
                padding-right: 64px;
            }
            .nickname-id-overlay {
                position: absolute;
                right: 10px;
                font-size: 11px;
                color: #6b7280;
                pointer-events: none;
            }
        </style>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <div id="git-version">git: --</div>
        <div id="lobby-overlay">
            <div class="lobby-box">
                <h1 style="color: #fff; margin-bottom: 10px">
                    ğŸ§Ÿ æ®­å±æ£‹ Online
                </h1>
                <p style="color: #ccc; margin-bottom: 30px">
                    è¼¸å…¥æˆ¿é–“è™Ÿç¢¼èˆ‡æœ‹å‹å°æˆ°
                </p>
                <div class="lobby-fields">
                    <div class="lobby-row">
                        <label for="player-nickname">æš±ç¨±:</label>
                        <span class="nickname-field">
                            <input
                                type="text"
                                id="player-nickname"
                                class="lobby-input"
                                maxlength="12"
                                placeholder="è¼¸å…¥æš±ç¨±"
                            />
                            <span
                                class="nickname-id-overlay"
                                id="player-id-display"
                            ></span>
                        </span>
                    </div>
                    <div class="lobby-row">
                        <label for="room-id">æˆ¿è™Ÿ:</label>
                        <input
                            type="text"
                            id="room-id"
                            class="lobby-input"
                            placeholder="ä¾‹å¦‚: 8888"
                            value=""
                        />
                    </div>
                </div>
                <div style="margin-bottom: 12px; color: #cbd5f5">
                    <label style="display: inline-flex; gap: 8px; align-items: center">
                        <input type="checkbox" id="solo-mode" />
                        å»ºç«‹å–®äººæˆ¿é–“ï¼ˆæˆ¿ä¸»å¯æ“æ§ç´…è—å…©è‰²ï¼‰
                    </label>
                </div>
                <br />
                <button class="lobby-btn" onclick="joinGame()">å‰µå»ºæˆ¿é–“</button>
                <p
                    id="conn-status"
                    style="margin-top: 20px; color: #f87171; font-size: 14px"
                ></p>
                <div class="room-list">
                    <h2 class="room-section-title">å¯åŠ å…¥æˆ¿é–“</h2>
                    <ul id="room-list"></ul>
                    <div id="room-empty" class="room-empty"></div>
                    <h2 class="room-section-title room-section-title--spaced">
                        å·²å­˜åœ¨æˆ¿é–“
                    </h2>
                    <ul id="room-list-existing"></ul>
                    <div id="room-existing-empty" class="room-empty"></div>
                    <button class="room-refresh" onclick="requestRoomList()">
                        é‡æ–°æ•´ç†åˆ—è¡¨
                    </button>
                </div>
            </div>
        </div>

        <div id="game-container">
            <div class="wrap">
                <div class="card" id="board-card">
                    <div class="status-bar">
                        <span style="color: var(--p1)"
                            >P1: <span id="s1">0</span>/8</span
                        >
                        <span
                            id="role-display"
                            style="
                                background: #334155;
                                padding: 2px 8px;
                                border-radius: 4px;
                                font-size: 0.8em;
                            "
                            >ç­‰å¾…å°æ‰‹...</span
                        >
                        <span style="color: var(--p2)"
                            >P2: <span id="s2">0</span>/8</span
                        >
                    </div>
                    <div
                        style="
                            text-align: center;
                            margin-bottom: 10px;
                            font-weight: bold;
                        "
                        id="turn-display"
                    ></div>
                    <div class="board-frame"><div id="game-board"></div></div>
                </div>

                <div class="side-column">
                    <div class="card" style="display: flex; flex-direction: column">
                        <h3 style="margin: 0 0 10px 0">å¾©æ´»ä¾›æ‡‰å€</h3>
                        <div
                            style="
                                color: var(--p1);
                                font-weight: bold;
                                font-size: 12px;
                            "
                        >
                            ç©å®¶ 1 (ç´…)
                        </div>
                        <div class="supply-row">
                            <button
                                class="btn supply-btn"
                                id="p1-L"
                                onclick="selectSupply(1,'L')"
                            >
                                å¤§<br /><span id="c1-L">0</span>
                            </button>
                            <button
                                class="btn supply-btn"
                                id="p1-M"
                                onclick="selectSupply(1,'M')"
                            >
                                ä¸­<br /><span id="c1-M">0</span>
                            </button>
                            <button
                                class="btn supply-btn"
                                id="p1-S"
                                onclick="selectSupply(1,'S')"
                            >
                                å°<br /><span id="c1-S">0</span>
                            </button>
                        </div>
                        <div
                            style="
                                color: var(--p2);
                                font-weight: bold;
                                font-size: 12px;
                                margin-top: 5px;
                            "
                        >
                            ç©å®¶ 2 (è—)
                        </div>
                        <div class="supply-row">
                            <button
                                class="btn supply-btn"
                                id="p2-L"
                                onclick="selectSupply(2,'L')"
                            >
                                å¤§<br /><span id="c2-L">0</span>
                            </button>
                            <button
                                class="btn supply-btn"
                                id="p2-M"
                                onclick="selectSupply(2,'M')"
                            >
                                ä¸­<br /><span id="c2-M">0</span>
                            </button>
                            <button
                                class="btn supply-btn"
                                id="p2-S"
                                onclick="selectSupply(2,'S')"
                            >
                                å°<br /><span id="c2-S">0</span>
                            </button>
                        </div>
                        <hr
                            style="
                                width: 100%;
                                border: 0;
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                                margin: 15px 0;
                            "
                        />
                        <div style="margin-top: auto">
                            <button
                                class="btn combo"
                                id="btn-end-combo"
                                onclick="endTurn()"
                            >
                                çµæŸé€£è·³
                            </button>
                            <button
                                class="btn"
                                style="background: #475569"
                                onclick="resetSelection()"
                            >
                                å–æ¶ˆé¸å–
                            </button>
                        </div>
                        <div class="log-area" id="log"></div>
                    </div>

                </div>
            </div>

            <details class="card rules-card">
                <summary>éŠæˆ²è²æ˜èˆ‡è¦å‰‡</summary>
                <div class="rules-content">
                    <h4>éŠæˆ²è²æ˜</h4>
                    <ul>
                        <li>æœ¬éŠæˆ²ç‚ºå€‹äººèˆˆè¶£ç·´ç¿’ä½œå“ï¼ŒéåŸå‰µéŠæˆ²ã€‚</li>
                        <li>åŸå§‹éŠæˆ²è¦å‰‡èˆ‡è¨­è¨ˆæ¦‚å¿µç”± ç‘ªå‰å¡å·¥ä½œå®¤ è£½ä½œã€‚</li>
                        <li>
                            åƒè€ƒå°ˆæ¡ˆï¼š
                            <a href="https://www.zeczec.com/projects/Catandjump" target="_blank" rel="noreferrer">
                                https://www.zeczec.com/projects/Catandjump
                            </a>
                        </li>
                        <li>æœ¬ä½œå“åƒ…ä½œç‚ºå­¸ç¿’ã€ç ”ç©¶èˆ‡æŠ€è¡“ç·´ç¿’ç”¨é€”ï¼Œæœªç”¨æ–¼ä»»ä½•å•†æ¥­è¡Œç‚ºã€‚</li>
                    </ul>

                    <h4>æ®­å±æ£‹å­</h4>
                    <ul>
                        <li>3 éšæ®­å±æ£‹ï¼ˆLï¼‰Ã— 1</li>
                        <li>2 éšæ®­å±æ£‹ï¼ˆMï¼‰Ã— 4</li>
                        <li>1 éšæ®­å±æ£‹ï¼ˆSï¼‰Ã— 5</li>
                    </ul>

                    <h4>å›åˆè¡Œå‹•è¦å‰‡</h4>
                    <p>ç©å®¶åœ¨è‡ªå·±çš„å›åˆä¸­ï¼Œå¿…é ˆé¸æ“‡ä¸¦åŸ·è¡Œä»¥ä¸‹ä¸‰ç¨®è¡Œå‹•ä¹‹ä¸€ï¼š</p>
                    <ol>
                        <li>
                            <strong>å¾©æ´»ï¼š</strong>
                            ç©å®¶å¯ä»¥å°‡é™½é–“ä¸­ä»»æ„ä¸€æšå±¬æ–¼è‡ªå·±çš„æ®­å±æ£‹ï¼Œæ”¾ç½®åˆ°æ£‹ç›¤ä¸Šä»»æ„ä¸€å€‹ç©ºæ ¼ä½ç½®ã€‚
                        </li>
                        <li>
                            <strong>ç§»å‹•ï¼š</strong>
                            ç©å®¶å¯ä»¥é¸æ“‡åŒä¸€æ ¼å…§çš„æ‰€æœ‰æ®­å±æ£‹ï¼Œæ²¿ç›´ç·šæ–¹å‘ç§»å‹•è‡³ç›¸é„°çš„ä¸€å€‹ç©ºæ ¼ã€‚è‹¥ç§»å‹•ç›®æ¨™æ ¼çš„æœ€ä¸Šæ–¹ï¼Œå­˜åœ¨æˆ‘æ–¹éšç´šæ›´é«˜çš„æ®­å±æ£‹ï¼Œå‰‡å¯ä»¥é€²è¡Œã€Œä¸Šç–Šã€ã€‚ä¸Šç–Šå¾Œï¼Œæ®­å±æ£‹çš„éšç´šæ•¸å€¼å°‡ç›¸åŠ ï¼Œå½¢æˆæ›´é«˜éšçš„æ®­å±æ£‹ã€‚
                        </li>
                        <li>
                            <strong>è·³èºï¼š</strong>
                            ç©å®¶å¯ä»¥é¸æ“‡åŒä¸€æ ¼å…§çš„è‡ªå·±æ‰€æœ‰æ®­å±æ£‹é€²è¡Œè·³èºï¼Œä¸¦è—‰æ­¤ç²å¾—åˆ†æ•¸ã€‚
                        </li>
                    </ol>

                    <h4>è·³èºè¦å‰‡</h4>
                    <ul>
                        <li>ç©å®¶é¸æ“‡ä¸€æ ¼å…§çš„è‡ªå·±æ‰€æœ‰æ®­å±æ£‹ã€‚</li>
                        <li>æ²¿ç›´ç·šæ–¹å‘è·³éé€£çºŒæ’åˆ—çš„æ®­å±æ£‹ã€‚</li>
                        <li>è¢«è·³éçš„æ®­å±æ£‹ï¼Œå¯ä»¥æ˜¯æˆ‘æ–¹æˆ–å°æ‰‹çš„æ®­å±æ£‹ã€‚</li>
                    </ul>

                    <h4>å¾—åˆ†è¦å‰‡</h4>
                    <ul>
                        <li>æ¯ç•¶è·³èºè¶Šéä¸€æšæ•µæ–¹æ®­å±æ£‹æ™‚ï¼Œè©²æ®­å±æ£‹æœƒè¢«é€è‡³é™½é–“ã€‚</li>
                        <li>ç©å®¶å¯ç²å¾—æ‰€æœ‰è¢«é€è‡³é™½é–“çš„æ•µæ–¹æ®­å±æ£‹éšç´šæ•¸å€¼ç¸½å’Œï¼Œä½œç‚ºæœ¬æ¬¡è·³èºå¾—åˆ†ã€‚</li>
                    </ul>

                    <h4>è·³èºé™åˆ¶èˆ‡å»¶çºŒæ¢ä»¶</h4>
                    <ul>
                        <li>
                            æ‰€é¸æ®­å±æ£‹çš„éšç´šç¸½å’Œï¼Œå¿…é ˆå¤§æ–¼æˆ–ç­‰æ–¼æ‰€æœ‰è¢«è¶Šéæ®­å±æ£‹çš„éšç´šç¸½å’Œã€‚
                        </li>
                        <li>
                            è·³èºå¾Œè‹¥è½åœ¨ç©ºæ ¼ä¸Šï¼Œç©å®¶å¯ä»¥é¸æ“‡è®“è©²çµ„æ®­å±æ£‹ç¹¼çºŒé€²è¡Œè·³èºè¡Œå‹•ï¼Œç›´åˆ°ç©å®¶ä¸»å‹•çµæŸï¼Œæˆ–ç„¡æ³•å†é€²è¡Œè·³èºã€‚
                        </li>
                        <li>
                            ç©å®¶ä¹Ÿå¯ä»¥é¸æ“‡è·³åˆ°æˆ‘æ–¹éšç´šæ›´é«˜çš„æ®­å±æ£‹ä¸Šé€²è¡Œã€Œä¸Šç–Šã€ï¼Œæˆ–è·³å‡ºæ£‹ç›¤ç›´æ¥é€²å…¥é™½é–“ã€‚åªè¦é¸æ“‡ã€Œä¸Šç–Šã€æˆ–ã€Œè·³å‡ºæ£‹ç›¤ã€ï¼Œè©²æ¬¡è·³èºè¡Œå‹•ç«‹å³çµæŸï¼Œä¸å¯å†ç¹¼çºŒè·³èºã€‚
                        </li>
                    </ul>

                    <h4>é™½é–“èˆ‡å›æ­¸</h4>
                    <p>
                        è·³å‡ºæ£‹ç›¤çš„æ®­å±æ£‹ï¼Œæœƒæš«æ™‚ç•™åœ¨é™½é–“ã€‚å¿…é ˆé€éã€Œå¾©æ´»è¡Œå‹•ã€ï¼Œæ‰èƒ½é‡æ–°å›åˆ°æ£‹ç›¤ï¼ˆé™°é–“ï¼‰ã€‚
                    </p>

                    <h4>å‹åˆ©æ¢ä»¶</h4>
                    <p>
                        ç•¶ä»»ä¸€ç©å®¶çš„åˆ†æ•¸è»Œåˆ°é” 8 åˆ†æ™‚ï¼ŒéŠæˆ²ç«‹å³çµæŸã€‚è©²ç©å®¶ç²å¾—å‹åˆ©ã€‚
                    </p>
                </div>
            </details>
        </div>

        <script>
            // --- ç¶²è·¯é€£ç·šè¨­å®š ---
            const socket = io();
            let myPlayerNum = 0;
            let currentRoomId = "";
            let isGameOver = false;
            let roomMode = "multi";
            let isSoloHost = false;
            const gitVersionElement = document.getElementById("git-version");
            const roomInput = document.getElementById("room-id");
            const playerIdDisplay = document.getElementById("player-id-display");
            const nicknameInput = document.getElementById("player-nickname");
            const PLAYER_ID_KEY = "zombie-chess-player-id";
            const PLAYER_NICKNAME_KEY = "zombie-chess-player-nickname";
            const playerId = (() => {
                const existing = localStorage.getItem(PLAYER_ID_KEY);
                if (existing) {
                    return existing;
                }
                const generated =
                    (window.crypto?.randomUUID && window.crypto.randomUUID()) ||
                    `P${Math.random().toString(36).slice(2, 10)}`;
                localStorage.setItem(PLAYER_ID_KEY, generated);
                return generated;
            })();
            const shortPlayerId = playerId
                .replace(/[^a-zA-Z0-9]/g, "")
                .slice(-6);

            if (playerIdDisplay) {
                const idText = shortPlayerId || playerId;
                playerIdDisplay.innerText = idText ? `-${idText}` : "";
            }
            if (nicknameInput) {
                nicknameInput.value =
                    localStorage.getItem(PLAYER_NICKNAME_KEY) || "";
                nicknameInput.addEventListener("input", () => {
                    localStorage.setItem(
                        PLAYER_NICKNAME_KEY,
                        nicknameInput.value.trim(),
                    );
                });
            }

            if (roomInput) {
                roomInput.dataset.userEdited = "false";
                if (!roomInput.value) {
                    roomInput.value = Math.floor(
                        1000 + Math.random() * 9000,
                    ).toString();
                }
                roomInput.addEventListener("input", () => {
                    roomInput.dataset.userEdited = "true";
                });
            }

            fetch("/version")
                .then((response) => response.json())
                .then((data) => {
                    const version = data?.version || "unknown";
                    if (gitVersionElement) {
                        gitVersionElement.innerText = `git: ${version}`;
                    }
                })
                .catch(() => {
                    if (gitVersionElement) {
                        gitVersionElement.innerText = "git: unknown";
                    }
                });

            function joinGame() {
                const room = document.getElementById("room-id").value;
                if (!room) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼");
                const isSolo =
                    document.getElementById("solo-mode")?.checked || false;
                socket.emit("joinRoom", {
                    roomId: room,
                    mode: isSolo ? "solo" : "multi",
                    playerId,
                });
                document.getElementById("conn-status").innerText = "é€£ç·šä¸­...";
            }

            function requestRoomList() {
                socket.emit("getRooms");
            }

            function renderRoomList(rooms) {
                const list = document.getElementById("room-list");
                const empty = document.getElementById("room-empty");
                list.innerHTML = "";

                if (!rooms.length) {
                    empty.innerText = "ç›®å‰æ²’æœ‰å¯åŠ å…¥çš„æˆ¿é–“";
                    return;
                }

                empty.innerText = "";

                rooms.forEach((room) => {
                    const li = document.createElement("li");
                    li.className = "room-item";

                    const meta = document.createElement("div");
                    meta.className = "room-meta";
                    const modeLabel = room.mode === "solo" ? "å–®äºº" : "å°æˆ°";
                    meta.innerHTML = `<span>æˆ¿é–“ ${room.roomId}</span><small>${modeLabel}ï½œç©å®¶ ${room.players}/${room.maxPlayers}</small>`;

                    const btn = document.createElement("button");
                    btn.className = "room-join";
                    btn.innerText = room.canJoin ? "åŠ å…¥" : "å·²æ»¿";
                    btn.disabled = !room.canJoin;
                    btn.onclick = () => {
                        document.getElementById("room-id").value =
                            room.roomId;
                        joinGame();
                    };

                    li.appendChild(meta);
                    li.appendChild(btn);
                    list.appendChild(li);
                });
            }

            function renderExistingRoomList(rooms) {
                const list = document.getElementById("room-list-existing");
                const empty = document.getElementById("room-existing-empty");
                list.innerHTML = "";

                if (!rooms.length) {
                    empty.innerText = "ç›®å‰æ²’æœ‰å…¶ä»–å·²å­˜åœ¨çš„æˆ¿é–“";
                    return;
                }

                empty.innerText = "";

                rooms.forEach((room) => {
                    const li = document.createElement("li");
                    li.className = "room-item room-item--inactive";

                    const meta = document.createElement("div");
                    meta.className = "room-meta";
                    const modeLabel = room.mode === "solo" ? "å–®äºº" : "å°æˆ°";
                    meta.innerHTML = `<span>æˆ¿é–“ ${room.roomId}</span><small>${modeLabel}ï½œç©å®¶ ${room.players}/${room.maxPlayers}</small>`;

                    const btn = document.createElement("button");
                    btn.className = "room-join";
                    btn.innerText = "å·²æ»¿";
                    btn.disabled = true;

                    li.appendChild(meta);
                    li.appendChild(btn);
                    list.appendChild(li);
                });
            }

            function generateRandomRoomId(existingIds) {
                let nextId = "";
                let attempts = 0;
                do {
                    nextId = Math.floor(1000 + Math.random() * 9000).toString();
                    attempts += 1;
                } while (existingIds.has(nextId) && attempts < 50);
                return nextId;
            }

            function syncRoomInputIfExists(rooms) {
                if (!roomInput || roomInput.dataset.userEdited === "true") {
                    return;
                }
                const existingIds = new Set(
                    rooms.map((room) => room.roomId.toString()),
                );
                if (existingIds.has(roomInput.value)) {
                    roomInput.value = generateRandomRoomId(existingIds);
                }
            }

            socket.on("roomsUpdated", (rooms) => {
                const joinableRooms = rooms.filter((room) => room.canJoin);
                const existingRooms = rooms.filter((room) => !room.canJoin);
                renderRoomList(joinableRooms);
                renderExistingRoomList(existingRooms);
                syncRoomInputIfExists(rooms);
            });

            socket.on(
                "playerAssigned",
                ({ playerNum, roomId, roomMode: assignedMode, isSoloHost: solo }) => {
                myPlayerNum = playerNum;
                currentRoomId = roomId;
                roomMode = assignedMode || "multi";
                isSoloHost = !!solo;
                document.getElementById("lobby-overlay").style.display = "none";
                document.getElementById("game-container").style.display =
                    "flex";
                document.getElementById("game-container").style.justifyContent =
                    "flex-start";
                if (roomMode === "solo") {
                    document.getElementById("role-display").innerText =
                        "å–®äººæ¨¡å¼ï¼šä½ å¯æ“ä½œç´…è—é›™æ–¹";
                    log(`åŠ å…¥å–®äººæˆ¿é–“ ${roomId}ï¼Œä½ å¯æ“ä½œé›™æ–¹`);
                } else {
                    document.getElementById("role-display").innerText =
                        `ä½ æ˜¯: ç©å®¶ ${playerNum} (${playerNum == 1 ? "ç´…" : "è—"})`;
                    log(`åŠ å…¥æˆ¿é–“ ${roomId}ï¼Œä½ æ˜¯ P${playerNum}`);
                }
                if (playerNum === 1) {
                    initGameData();
                    syncServer();
                }
            },
            );

            socket.on("gameStart", () => {
                if (roomMode === "solo") {
                    log("å–®äººæ¨¡å¼é–‹å§‹ï¼");
                } else {
                    log("å°æ‰‹å·²åŠ å…¥ï¼ŒéŠæˆ²é–‹å§‹ï¼");
                }
            });
            socket.on("playerAction", ({ message }) => {
                log(message);
            });
            socket.on("errorMsg", (msg) => {
                alert(msg);
                document.getElementById("conn-status").innerText = msg;
            });
            socket.on("playerDisconnected", () => {
                alert("å°æ‰‹å·²æ–·ç·šï¼");
                location.reload();
            });

            requestRoomList();

            socket.on("stateUpdated", (data) => {
                board = data.board;
                scores = data.scores;
                supply = data.supply;
                currentPlayer = data.turn;

                if (isComboMode && !canControlPlayer(currentPlayer)) {
                    isComboMode = false;
                    resetSelection();
                }

                render();
                checkWin();
            });

            // --- éŠæˆ²é‚è¼¯ ---
            const SIZE = 7;
            const PIECE_VALS = { L: 3, M: 2, S: 1 };
            const MAX_PIECES = { L: 1, M: 4, S: 5 };

            let board = [];
            let scores = { 1: 0, 2: 0 };
            let supply = { 1: {}, 2: {} };
            let currentPlayer = 1;
            let selectedCell = null;
            let reviveSelection = null;
            let validMoves = [];
            let isComboMode = false;

            function initGameData() {
                scores = { 1: 0, 2: 0 };
                currentPlayer = 1;
                isGameOver = false;
                board = Array.from({ length: SIZE }, () =>
                    Array.from({ length: SIZE }, () => []),
                );
                const layout = [
                    { r: 1, row: [2, 0, 3, 0, 2], p: 2 },
                    { r: 2, row: [1, 1, 1, 1, 1], p: 2 },
                    { r: 4, row: [1, 1, 1, 1, 1], p: 1 },
                    { r: 5, row: [2, 0, 3, 0, 2], p: 1 },
                ];
                let used = { 1: { L: 0, M: 0, S: 0 }, 2: { L: 0, M: 0, S: 0 } };
                layout.forEach((cfg) => {
                    cfg.row.forEach((val, cIdx) => {
                        if (val > 0) {
                            let type = val === 3 ? "L" : val === 2 ? "M" : "S";
                            board[cfg.r][cIdx + 1].push({
                                type,
                                val,
                                player: cfg.p,
                            });
                            used[cfg.p][type]++;
                        }
                    });
                });
                [1, 2].forEach((p) => {
                    for (let k in MAX_PIECES)
                        supply[p][k] = MAX_PIECES[k] - used[p][k];
                });
                render();
            }

            function syncServer() {
                socket.emit("updateGame", {
                    roomId: currentRoomId,
                    newState: { board, scores, supply, turn: currentPlayer },
                });
            }

            function checkWin() {
                if (isGameOver) return;

                let winner = null;
                if (scores[1] >= 8) winner = 1;
                else if (scores[2] >= 8) winner = 2;

                if (winner) {
                    isGameOver = true;
                    setTimeout(() => {
                        const msg = `ğŸ† ç©å®¶ ${winner} (${winner == 1 ? "ç´…" : "è—"}) ç²å‹ï¼`;
                        const div = document.createElement("div");
                        div.className = "winner-overlay";
                        div.innerHTML = `<div class="winner-text">${msg}</div><button class="lobby-btn" onclick="location.reload()">é‡æ–°æ•´ç†å†ä¾†ä¸€å±€</button>`;
                        document.body.appendChild(div);
                    }, 100);
                }
            }

            function isAfterlife(r, c) {
                return r === 0 || r === 6 || c === 0 || c === 6;
            }
            function getStackVal(stack) {
                return stack.reduce((a, b) => a + b.val, 0);
            }
            function getStackLabel(stack) {
                return stack.map((p) => p.type).join("");
            }
            function log(msg) {
                const el = document.getElementById("log");
                el.innerHTML += `<div class="log-line">${msg}</div>`;
                el.scrollTop = el.scrollHeight;
            }
            function emitAction(message) {
                if (!currentRoomId) return;
                socket.emit("playerAction", {
                    roomId: currentRoomId,
                    message,
                });
            }
            function formatCell(r, c) {
                return `(${r + 1}, ${c + 1})`;
            }
            function formatPlayerLabel(playerNum) {
                return `ç©å®¶ ${playerNum} (${playerNum == 1 ? "ç´…" : "è—"})`;
            }
            function canControlPlayer(playerNum) {
                return myPlayerNum === playerNum || isSoloHost;
            }

            function handleCell(r, c) {
                if (isGameOver) return;
                if (!canControlPlayer(currentPlayer)) return;

                if (isComboMode) {
                    let m = validMoves.find((x) => x.r === r && x.c === c);
                    if (m) execute(m);
                    else if (r === selectedCell.r && c === selectedCell.c) {
                    } else alert("é€£è·³ä¸­ï¼šè«‹é¸æ“‡ç›®æ¨™æˆ–çµæŸé€£è·³");
                    return;
                }

                if (reviveSelection) {
                    if (!isAfterlife(r, c) && board[r][c].length === 0) {
                        let t = reviveSelection;
                        if (supply[currentPlayer][t] > 0) {
                            supply[currentPlayer][t]--;
                            board[r][c].push({
                                type: t,
                                val: PIECE_VALS[t],
                                player: currentPlayer,
                            });
                            emitAction(
                                `${formatPlayerLabel(currentPlayer)} å¾©æ´» ${t} åˆ° ${formatCell(r, c)}`,
                            );
                            resetSelection();
                            syncServer(); // å¾©æ´»å¾Œè‡ªå‹•çµæŸå›åˆ (é€™è£¡é‚„æ˜¯è‡ªå‹•ï¼Œå› ç‚ºå¾©æ´»ä¸æ˜¯é€£è·³)
                            endTurn();
                        }
                    } else resetSelection();
                    return;
                }

                let stack = board[r][c];
                if (stack.length > 0 && stack[0].player === currentPlayer) {
                    if (
                        selectedCell &&
                        selectedCell.r === r &&
                        selectedCell.c === c
                    )
                        resetSelection();
                    else {
                        selectedCell = { r, c };
                        validMoves = calcMoves(r, c);
                        render();
                    }
                    return;
                }

                if (selectedCell) {
                    let m = validMoves.find(
                        (x) =>
                            x.r === r &&
                            x.c === c &&
                            !["stack", "jump-stack"].includes(x.type),
                    );
                    if (m) execute(m);
                    else resetSelection();
                }
            }

            function calcMoves(r, c) {
                let moves = [];
                let stack = board[r][c];
                if (stack.length === 0) return [];
                let myVal = getStackVal(stack);
                let myBottomVal = stack[0].val;
                const dirs = [
                    [-1, 0],
                    [1, 0],
                    [0, -1],
                    [0, 1],
                ];

                dirs.forEach(([dr, dc]) => {
                    if (!isComboMode) {
                        let nr = r + dr,
                            nc = c + dc;
                        if (
                            nr >= 0 &&
                            nr < SIZE &&
                            nc >= 0 &&
                            nc < SIZE &&
                            !isAfterlife(nr, nc)
                        ) {
                            let target = board[nr][nc];
                            if (target.length === 0)
                                moves.push({ r: nr, c: nc, type: "move" });
                            else if (
                                target[0].player === currentPlayer &&
                                myBottomVal < target[target.length - 1].val
                            ) {
                                moves.push({ r: nr, c: nc, type: "stack" });
                            }
                        }
                    }

                    let jr = r + dr,
                        jc = c + dc;
                    let enemyScore = 0; // åªè¨ˆç®—åˆ†æ•¸çš„æ•µæ–¹ç¸½å’Œ
                    let jumpedVal = 0; // ä¿®æ­£ï¼šè¨ˆç®—è·¯å¾‘ä¸Šã€Œæ‰€æœ‰ã€æ£‹å­çš„ç¸½å’Œï¼ˆæ•µ+æˆ‘ï¼‰
                    let victims = [];

                    while (jr >= 0 && jr < SIZE && jc >= 0 && jc < SIZE) {
                        let tStack = board[jr][jc];

                        if (tStack.length === 0) {
                            // è·³èºåˆ¤å®šï¼šè·é›¢>1 ä¸” æˆ‘æ–¹æ•¸å€¼ >= è·¯å¾‘ä¸Šæ‰€æœ‰æ£‹å­ç¸½å’Œ
                            if (
                                Math.abs(jr - r) + Math.abs(jc - c) > 1 &&
                                myVal >= jumpedVal
                            ) {
                                let isSacrifice = isAfterlife(jr, jc);
                                moves.push({
                                    r: jr,
                                    c: jc,
                                    type: isSacrifice ? "sacrifice" : "jump",
                                    score: enemyScore,
                                    victims: [...victims],
                                });
                            }
                            break;
                        }

                        // ç´¯è¨ˆè·¯å¾‘é˜»åŠ› (æ•µ+æˆ‘)
                        let cellVal = getStackVal(tStack);

                        // å¦‚æœé‡åˆ°å·±æ–¹ï¼Œå…ˆæª¢æŸ¥æ˜¯å¦å¯ä¸Šç–Š (Landing on friend)
                        if (tStack[0].player === currentPlayer) {
                            if (
                                Math.abs(jr - r) + Math.abs(jc - c) > 1 &&
                                myVal >= jumpedVal &&
                                myBottomVal < tStack[tStack.length - 1].val
                            ) {
                                moves.push({
                                    r: jr,
                                    c: jc,
                                    type: "jump-stack",
                                    score: enemyScore,
                                    victims: [...victims],
                                });
                            }
                        }

                        // å°‡æ­¤æ ¼åŠ å…¥ã€Œå·²è¶Šéçš„é˜»åŠ›ã€
                        jumpedVal += cellVal;

                        if (tStack[0].player !== currentPlayer) {
                            enemyScore += cellVal;
                            victims.push({ r: jr, c: jc });
                        }

                        jr += dr;
                        jc += dc;
                    }
                });
                return moves;
            }

            function execute(m) {
                let sr = selectedCell.r,
                    sc = selectedCell.c;
                let mover = board[sr][sc];
                let moverLabel = getStackLabel(mover);
                let playerLabel = formatPlayerLabel(currentPlayer);
                let actionBase = `${playerLabel} ${moverLabel} å¾ ${formatCell(
                    sr,
                    sc,
                )} `;

                // åƒå­
                if (["jump", "sacrifice", "jump-stack"].includes(m.type)) {
                    m.victims.forEach((v) => {
                        board[v.r][v.c].forEach(
                            (p) => supply[p.player][p.type]++,
                        );
                        board[v.r][v.c] = [];
                    });
                    scores[currentPlayer] += m.score;
                }
                board[sr][sc] = [];

                // æ¨èº«èˆ‡ä¸Šç–Šï¼šå¼·åˆ¶çµæŸï¼Œä½†æ”¹ç‚ºç­‰å¾…ç©å®¶æ‰‹å‹•æŒ‰æŒ‰éˆ•
                if (m.type === "sacrifice") {
                    mover.forEach((p) => supply[p.player][p.type]++);
                    emitAction(
                        `${actionBase}æ¨èº«è·³èºåˆ° ${formatCell(
                            m.r,
                            m.c,
                        )}ï¼ˆå¾—åˆ† ${m.score}ï¼‰`,
                    );
                    enterComboWaitState();
                    return;
                }
                if (m.type === "jump-stack") {
                    board[m.r][m.c].push(...mover);
                    emitAction(
                        `${actionBase}è·³èºç–Šåˆ° ${formatCell(
                            m.r,
                            m.c,
                        )}ï¼ˆå¾—åˆ† ${m.score}ï¼‰`,
                    );
                    enterComboWaitState();
                    return;
                }

                // ç§»å‹•/å †ç–Š (éè·³èº)ï¼šç›´æ¥çµæŸ
                if (m.type === "stack") {
                    board[m.r][m.c].push(...mover);
                    emitAction(
                        `${actionBase}ç–Šåˆ° ${formatCell(m.r, m.c)}`,
                    );
                } else if (m.type === "move") {
                    board[m.r][m.c] = mover;
                    emitAction(
                        `${actionBase}ç§»å‹•åˆ° ${formatCell(m.r, m.c)}`,
                    );
                } else {
                    board[m.r][m.c] = mover;
                }

                // é€£è·³æª¢æŸ¥
                if (m.type === "jump") {
                    emitAction(
                        `${actionBase}è·³èºåˆ° ${formatCell(
                            m.r,
                            m.c,
                        )}ï¼ˆå¾—åˆ† ${m.score}ï¼‰`,
                    );
                    let nextMoves = calcMoves(m.r, m.c).filter((nm) =>
                        ["jump", "sacrifice", "jump-stack"].includes(nm.type),
                    );
                    if (nextMoves.length > 0) {
                        isComboMode = true;
                        selectedCell = { r: m.r, c: m.c };
                        validMoves = nextMoves;
                        syncServer();
                        render();
                        return;
                    }
                }

                // è‹¥ç„¡ä¸‹ä¸€æ­¥ï¼Œé€²å…¥ã€Œç­‰å¾…çµæŸã€ç‹€æ…‹ï¼Œè€Œéè‡ªå‹•çµæŸ
                // é€™æ˜¯ç‚ºäº†æ»¿è¶³ã€Œæ‰€æœ‰è·³èºæ“æ§æ”¹ç‚ºæ‰‹å‹•çµæŸã€çš„éœ€æ±‚
                if (m.type === "jump") {
                    enterComboWaitState();
                } else {
                    endTurn(); // æ™®é€šç§»å‹•é‚„æ˜¯è‡ªå‹•çµæŸæ¯”è¼ƒé †æš¢
                }
            }

            function enterComboWaitState() {
                selectedCell = null;
                validMoves = [];
                isComboMode = true; // ä¿æŒé€™å€‹ç‹€æ…‹ä»¥é¡¯ç¤ºæŒ‰éˆ•
                syncServer();
                render();
            }

            function selectSupply(p, type) {
                if (isGameOver) return;
                if (
                    p !== currentPlayer ||
                    !canControlPlayer(p) ||
                    isComboMode
                )
                    return;
                if (supply[p][type] <= 0) return;
                reviveSelection = type;
                selectedCell = null;
                validMoves = [];
                render();
            }

            function endTurn() {
                if (!canControlPlayer(currentPlayer)) return;
                emitAction(`${formatPlayerLabel(currentPlayer)} çµæŸå›åˆ`);
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                isComboMode = false;
                resetSelection();
                syncServer();
            }

            function resetSelection() {
                selectedCell = null;
                reviveSelection = null;
                validMoves = [];
                render();
            }

            function render() {
                const elBoard = document.getElementById("game-board");
                elBoard.innerHTML = "";

                document.getElementById("s1").innerText = scores[1];
                document.getElementById("s2").innerText = scores[2];
                let turnTxt = document.getElementById("turn-display");
                turnTxt.innerText = `è¼ªåˆ°: ç©å®¶ ${currentPlayer} (${currentPlayer == 1 ? "ç´…" : "è—"})`;
                turnTxt.style.color =
                    currentPlayer == 1 ? "var(--p1)" : "var(--p2)";

                const boardCard = document.getElementById("board-card");
                if (canControlPlayer(currentPlayer) && !isGameOver)
                    boardCard.classList.add("my-turn");
                else boardCard.classList.remove("my-turn");

                const btnEnd = document.getElementById("btn-end-combo");
                if (isComboMode) {
                    btnEnd.style.display = "block";
                    btnEnd.innerText =
                        validMoves.length > 0
                            ? "çµæŸé€£è·³ (é‚„æœ‰æ­¥æ•¸)"
                            : "çµæŸå›åˆ";
                } else {
                    btnEnd.style.display = "none";
                }

                ["L", "M", "S"].forEach((t) => {
                    document.getElementById(`c1-${t}`).innerText = supply[1][t];
                    document.getElementById(`c2-${t}`).innerText = supply[2][t];

                    let btn1 = document.getElementById(`p1-${t}`);
                    let btn2 = document.getElementById(`p2-${t}`);
                    let canP1 =
                        currentPlayer === 1 &&
                        canControlPlayer(1) &&
                        supply[1][t] > 0 &&
                        !isComboMode &&
                        !isGameOver;
                    let canP2 =
                        currentPlayer === 2 &&
                        canControlPlayer(2) &&
                        supply[2][t] > 0 &&
                        !isComboMode &&
                        !isGameOver;

                    btn1.disabled = !canP1;
                    btn2.disabled = !canP2;
                    btn1.className = `btn supply-btn ${reviveSelection === t && canP1 ? "active" : ""}`;
                    btn2.className = `btn supply-btn ${reviveSelection === t && canP2 ? "active" : ""}`;
                });

                for (let r = 0; r < SIZE; r++) {
                    for (let c = 0; c < SIZE; c++) {
                        let div = document.createElement("div");
                        div.className = `cell ${isAfterlife(r, c) ? "afterlife" : "underworld"}`;
                        div.onclick = () => handleCell(r, c);

                        let stack = board[r][c];

                        if (
                            reviveSelection &&
                            !isAfterlife(r, c) &&
                            stack.length === 0
                        ) {
                            div.classList.add("valid-revive-hint");
                        }

                        if (stack.length > 0) {
                            let container = document.createElement("div");
                            container.className = "piece-container";
                            let label = getStackLabel(stack);
                            stack.forEach((p, idx) => {
                                let pDiv = document.createElement("div");
                                pDiv.className = `piece p${p.player} size-${p.type}`;
                                if (idx === stack.length - 1)
                                    pDiv.innerText = label;
                                container.appendChild(pDiv);
                            });
                            div.appendChild(container);
                        }
                        if (
                            selectedCell &&
                            selectedCell.r === r &&
                            selectedCell.c === c
                        )
                            div.classList.add("selected");

                        let move = validMoves.find(
                            (m) => m.r === r && m.c === c,
                        );
                        if (move) {
                            if (move.type.includes("stack")) {
                                let dot = document.createElement("div");
                                dot.className = "stack-dot";
                                if (move.type === "jump-stack") {
                                    dot.style.background = "#a855f7";
                                    dot.style.borderColor = "#fff";
                                    div.classList.add("valid-jump-stack");
                                }
                                dot.onclick = (e) => {
                                    e.stopPropagation();
                                    execute(move);
                                };
                                div.appendChild(dot);
                            } else {
                                if (move.type === "move") {
                                    let ind = document.createElement("div");
                                    ind.className = "indicator indicator-move";
                                    div.appendChild(ind);
                                } else if (move.type === "jump") {
                                    let ind = document.createElement("div");
                                    ind.className =
                                        "indicator indicator-attack";
                                    div.appendChild(ind);
                                } else if (move.type === "sacrifice") {
                                    let ind = document.createElement("div");
                                    ind.className =
                                        "indicator indicator-sacrifice";
                                    div.appendChild(ind);
                                }
                            }
                        }
                        elBoard.appendChild(div);
                    }
                }
            }
        </script>
    </body>
</html>
